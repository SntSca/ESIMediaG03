<div class="full-screen-wrapper">
  <div class="page-wrapper">
    <!-- üîπ Barra superior con perfil -->
    <nav class="navbar">
      <ul class="navbar-options">
        <li><a class="active">Gesti√≥n de Contenidos</a></li>
      </ul>

      <div class="user-panel">
        <div class="user-photo">
          <span class="user-photo-fallback">{{ userInitials }}</span>
        </div>

        <div class="user-info">
          <div class="user-name">{{ userName }}</div>
          <div class="user-email">{{ userEmail }}</div>
          <div class="user-role">{{ userRole }}</div>
        </div>
        <button class="logout-btn" (click)="cerrarSesion()">Cerrar Sesi√≥n</button>
      </div>
    </nav>

    <!-- üîπ Contenido principal: Toolbar + Modal de alta -->
    <div class="main-container">
      <main class="content-area">
        <div class="toolbar">
          <h2 class="page-title">Contenidos</h2>
          <button class="primary-btn" (click)="abrirCrear()">‚ûï A√±adir contenido</button>
        </div>

        <!-- Mensajes globales -->
        <div *ngIf="errorMsg" class="error-container"><p>{{ errorMsg }}</p></div>
        <div *ngIf="successMsg" class="success-container"><p>{{ successMsg }}</p></div>

        <!-- üß© Modal de creaci√≥n (solo cierra en X/Cancelar/Guardar OK) -->
        <div class="modal" *ngIf="crearAbierto" role="dialog" aria-modal="true" aria-labelledby="modalTitulo">
          <!-- backdrop visual SIN handlers -->
          <div class="modal-backdrop" aria-hidden="true"></div>

          <div class="modal-content" tabindex="0">
            <button class="modal-close" (click)="cerrarCrear()" aria-label="Cerrar">&times;</button>

            <h3 id="modalTitulo">Nuevo contenido</h3>
            <p class="helper-text">Rellena los datos y pulsa ‚ÄúGuardar‚Äù.</p>

            <!-- Banner de errores cruzados -->
            <div *ngIf="crossErrorsPresent" class="error-container">
              <p>Revisa los campos: hay incompatibilidades con el tipo seleccionado.</p>
            </div>

            <form #formSubida="ngForm" (ngSubmit)="subirContenido(formSubida)" novalidate class="upload-form">

              <!-- T√≠tulo -->
              <div class="form-row">
                <label for="titulo">T√≠tulo <span class="req">*</span></label>
                <input
                  id="titulo"
                  type="text"
                  name="titulo"
                  [(ngModel)]="nuevo.titulo"
                  #tituloModel="ngModel"
                  [ngModelOptions]="{ updateOn: 'change' }"
                  required
                  placeholder="p. ej., Interestelar" />
                <div class="field-msg" *ngIf="tituloModel.invalid && (tituloModel.dirty || tituloModel.touched)">
                  <span class="error" *ngIf="tituloModel.errors?.['required']">El t√≠tulo es obligatorio.</span>
                </div>
              </div>

              <!-- Descripci√≥n -->
              <div class="form-row">
                <label for="descripcion">Descripci√≥n</label>
                <textarea
                  id="descripcion"
                  name="descripcion"
                  [(ngModel)]="nuevo.descripcion"
                  [ngModelOptions]="{ updateOn: 'change' }"
                  rows="3"
                  placeholder="Breve descripci√≥n‚Ä¶"></textarea>
              </div>

              <!-- Tipo -->
              <div class="form-row">
                <label for="tipo">Tipo <span class="req">*</span></label>
                <select
                  id="tipo"
                  name="tipo"
                  [(ngModel)]="nuevo.tipo"
                  #tipoModel="ngModel"
                  [ngModelOptions]="{ updateOn: 'change' }"
                  required>
                  <option value="" disabled>Selecciona‚Ä¶</option>
                  <option value="AUDIO">Audio</option>
                  <option value="VIDEO">Video</option>
                </select>
                <div class="field-msg" *ngIf="tipoModel.invalid && (tipoModel.dirty || tipoModel.touched)">
                  <span class="error" *ngIf="tipoModel.errors?.['required']">Debes seleccionar el tipo.</span>
                </div>
              </div>

              <!-- Dependientes de tipo -->
              <div class="form-row" *ngIf="nuevo.tipo === 'AUDIO'">
                <label for="ficheroAudio">Fichero de audio <span class="req">*</span></label>
                <input
                  id="ficheroAudio"
                  type="text"
                  name="ficheroAudio"
                  [(ngModel)]="nuevo.ficheroAudio"
                  #ficheroAudioModel="ngModel"
                  [ngModelOptions]="{ updateOn: 'change' }"
                  required
                  placeholder="/ruta/o/nombre.mp3" />
                <div class="field-msg" *ngIf="(ficheroAudioModel.invalid && (ficheroAudioModel.dirty || ficheroAudioModel.touched)) || audioHasVideoFields">
                  <span class="error" *ngIf="ficheroAudioModel.errors?.['required']">Debes indicar el fichero de audio.</span>
                  <span class="error" *ngIf="audioHasVideoFields">Has indicado campos de v√≠deo (URL/Resoluci√≥n) con tipo AUDIO.</span>
                </div>
              </div>

              <ng-container *ngIf="nuevo.tipo === 'VIDEO'">
                <div class="form-row">
                  <label for="urlVideo">URL de v√≠deo <span class="req">*</span></label>
                  <input
                    id="urlVideo"
                    type="url"
                    name="urlVideo"
                    [(ngModel)]="nuevo.urlVideo"
                    #urlVideoModel="ngModel"
                    [ngModelOptions]="{ updateOn: 'change' }"
                    required
                    pattern="https?://.+"
                    placeholder="https://‚Ä¶" />
                  <div class="field-msg" *ngIf="urlVideoModel.invalid && (urlVideoModel.dirty || urlVideoModel.touched)">
                    <span class="error" *ngIf="urlVideoModel.errors?.['required']">Debes indicar la URL del v√≠deo.</span>
                    <span class="error" *ngIf="urlVideoModel.errors?.['pattern']">La URL debe empezar por http:// o https://</span>
                  </div>
                </div>

                <div class="form-row">
                  <label for="resolucion">Resoluci√≥n</label>
                  <select id="resolucion" name="resolucion" [(ngModel)]="nuevo.resolucion" [ngModelOptions]="{ updateOn: 'change' }">
                    <option value="">Selecciona‚Ä¶</option>
                    <option value="720p">720p</option>
                    <option value="1080p">1080p</option>
                    <option value="4K">4K</option>
                  </select>
                  <div class="field-msg hint"><span>S√≥lo 720p, 1080p o 4K.</span></div>
                </div>

                <!-- Error si hay ficheroAudio con tipo VIDEO -->
                <div class="field-msg" *ngIf="videoHasAudioField">
                  <span class="error">Has indicado fichero de audio con tipo VIDEO.</span>
                </div>
              </ng-container>

              <!-- Tags -->
              <div class="form-row">
                <label for="tags">Tags (separados por comas)</label>
                <input
                  id="tags"
                  type="text"
                  name="tags"
                  [(ngModel)]="nuevo.tagsStr"
                  [ngModelOptions]="{ updateOn: 'change' }"
                  placeholder="drama, scifi, estreno" />
                <div class="field-msg hint"><span>Ejemplo: drama, scifi, estreno</span></div>
              </div>

              <!-- Duraci√≥n -->
              <div class="form-row">
                <label for="duracion">Duraci√≥n (min) <span class="req">*</span></label>
                <input
                  id="duracion"
                  type="number"
                  name="duracion"
                  [(ngModel)]="nuevo.duracionMinutos"
                  #duracionModel="ngModel"
                  [ngModelOptions]="{ updateOn: 'change' }"
                  required
                  min="1"
                  placeholder="120" />
                <div class="field-msg" *ngIf="duracionModel.invalid && (duracionModel.dirty || duracionModel.touched)">
                  <span class="error" *ngIf="duracionModel.errors?.['required']">La duraci√≥n es obligatoria.</span>
                  <span class="error" *ngIf="duracionModel.errors?.['min']">Debe ser mayor a 0.</span>
                </div>
              </div>

              <!-- Flags -->
              <div class="form-grid">
                <div class="form-row">
                  <label for="vip">VIP</label>
                  <select id="vip" name="vip" [(ngModel)]="nuevo.vip" [ngModelOptions]="{ updateOn: 'change' }">
                    <option value="no">No</option>
                    <option value="si">S√≠</option>
                  </select>
                </div>

                <div class="form-row">
                  <label for="visible">Visible</label>
                  <select id="visible" name="visible" [(ngModel)]="nuevo.visible" [ngModelOptions]="{ updateOn: 'change' }">
                    <option value="no">No</option>
                    <option value="si">S√≠</option>
                  </select>
                </div>

                <div class="form-row">
                  <label for="restriccion">Restricci√≥n de edad</label>
                  <select id="restriccion" name="restriccion" [(ngModel)]="nuevo.restringidoEdad" [ngModelOptions]="{ updateOn: 'change' }">
                    <option value="no">No</option>
                    <option value="si">S√≠</option>
                  </select>
                </div>
              </div>

              <!-- Acciones -->
              <div class="form-actions">
                <button
                  type="submit"
                  class="primary-btn"
                  [disabled]="loading || !formSubida.valid || crossErrorsPresent">
                  {{ loading ? 'Guardando‚Ä¶' : 'Guardar' }}
                </button>
                <button
                  type="button"
                  class="secondary-btn"
                  (click)="cerrarCrear()"
                  [disabled]="loading">
                  Cancelar
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Placeholder -->
        <div class="placeholder">
          <p>Usa ‚ÄúA√±adir contenido‚Äù para crear uno nuevo.</p>
        </div>
      </main>
    </div>
  </div>
</div>
